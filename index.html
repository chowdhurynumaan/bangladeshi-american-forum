<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAF-M Digital Strategy Portal</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font family -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* Custom scrollbar for better appearance */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #5a67d8; border-radius: 4px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; }
        .transition-colors { transition: background-color 0.15s, color 0.15s; }
        .grid-auto-fit {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        /* Style for the active nav link */
        .nav-active {
            color: #ffffff !important;
            background-color: #38a169; /* BAF-M Primary Green */
            border-radius: 9999px;
            font-weight: 600;
        }
    </style>
</head>
<body>

<div id="app" class="min-h-screen flex flex-col">
    <!-- Header/Navigation Bar -->
    <header id="header" class="sticky top-0 z-50 bg-white shadow-lg">
        <!-- Content will be rendered here by JS -->
    </header>

    <!-- Main Content Area (Routing Container) -->
    <main id="content-container" class="flex-grow p-4 md:p-8">
        <!-- Page content will be dynamically rendered here -->
        <div class="max-w-7xl mx-auto">
            <p id="loading-message" class="text-center text-gray-500 py-20">Loading application...</p>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white p-6 text-center mt-auto">
        <p>&copy; <span id="current-year"></span> Bangladeshi American Forum - Michigan Chapter (BAF-M)</p>
        <p class="text-sm mt-1 text-gray-400">
            Authenticated User ID: <span id="footer-user-id" class="font-mono text-xs ml-2">...</span>
        </p>
    </footer>
</div>

<!-- Firebase SDK Imports (Module setup) -->
<script type="module">
   import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, Timestamp, getDocs, orderBy, limit, setLogLevel } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

    // --- GLOBAL FIREBASE & APP CONFIGURATION (FIXED USE) ---
    const firebaseConfig = {
        apiKey: "AIzaSyDtTKvYJjUYIvzcqOEXDwq3meVh2wHz3Qk",
        authDomain: "bangladeshiamericanforum.firebaseapp.com",
        projectId: "bangladeshiamericanforum",
        storageBucket: "bangladeshiamericanforum.firebasestorage.app",
        messagingSenderId: "362506019102",
        appId: "1:362506019102:web:9b7842d64d99deda6ba90f"
    };
    const appId = firebaseConfig.appId; // Use the fixed appId
    const initialAuthToken = null; // Always null since we are using fixed auth

    // Set up global references
    let app, db, auth;
    let userId = null;
    let isAuthReady = false;

    // --- FIX START: Define currentLang outside of the module scope for inline HTML handlers to access.    // However, since we are in a module, we will attach it to window for accessibility.
    let currentLang = localStorage.getItem('bafm_lang') || 'en';
    window.currentLang = currentLang;
    // --- FIX END

    // Data storage (for real-time updates)
let events = [];
let spotlights = [];
let volunteerNeeds = [];
let localBusinesses = [];
let civicIssues = []; // NEW: For Local Civic Summaries
let isMobileMenuOpen = false; // NEW: State for mobile menu

    // Utility to handle bilingual content lookup
    const t = (key) => LANG_CONTENT[key] ? LANG_CONTENT[key][currentLang] : `MISSING_KEY:${key}`;
    const t_data = (item, field) => item[`${field}_${currentLang}`] || item[field] || 'N/A';

    // --- BILINGUAL CONTENT MAPPING (PART IV) ---
    const LANG_CONTENT = {
        // Navigation & Global
        'nav_home': { 'en': 'Home', 'bn': 'হোম' },
        'nav_spotlight': { 'en': 'Spotlight', 'bn': 'স্পটলাইট' },
        'nav_events': { 'en': 'Events & Issues', 'bn': 'অনুষ্ঠান ও সমস্যা' },
        'nav_volunteer': { 'en': 'Volunteering', 'bn': 'স্বেচ্ছাসেবক' },
        'nav_submit': { 'en': 'Submissions Hub', 'bn': 'জমা দেওয়ার কেন্দ্র' },
        'language_toggle': { 'en': 'BN', 'bn': 'EN' },
        'loading_data': { 'en': 'Loading content...', 'bn': 'কন্টেন্ট লোড হচ্ছে...' },
        'no_content_available': { 'en': 'No content available right now.', 'bn': 'বর্তমানে কোনো কন্টেন্ট নেই।' },

        // Home Page (Part IV.A)
        'hero_headline': { 'en': 'Bangladeshi American Forum - Michigan', 'bn': 'বাংলাদেশি আমেরিকান ফোরাম - মিশিগান' },
        'hero_body': { 'en': 'Connecting the Bangladeshi Community in Michigan, Where You Live. Your reliable source for local news, events, and essential community resources across Warren, Sterling Heights, and Metro Detroit.', 'bn': 'মিশিগানে বসবাসরত বাংলাদেশী কমিউনিটিকে একসূত্রে গাঁথা। স্থানীয় খবর, ইভেন্ট এবং মেট্রো ডেট্রয়েট, ওয়ারেন ও স্টার্লিং হাইটসের আশেপাশে প্রয়োজনীয় কমিউনিটি রিসোর্সের জন্য আপনার নির্ভরযোগ্য ঠিকানা।' },
        'mission_title': { 'en': 'Our Mission', 'bn': 'আমাদের মিশন' },
        'mission_body': { 'en': 'To assist the Bangladeshi American Muslim community by prioritizing issues concerning their welfare and interests, founded upon core Islamic values.', 'bn': 'ইসলামী মূল্যবোধের ভিত্তিতে বাংলাদেশি আমেরিকান মুসলমানদের স্বার্থসংশ্লিষ্ট বিষয়গুলোকে অগ্রাধিকার দিয়ে কমিউনিটিকে সহযোগিতা করা।' },
        'vision_title': { 'en': 'Our Vision', 'bn': 'আমাদের ভিশন' },
        'vision_body': { 'en': 'To be the premier, trusted hub for all Bangladeshi Americans across Michigan, recognized for promoting unity, advocacy, and economic empowerment within our local neighborhoods.', 'bn': 'মিশিগান জুড়ে সকল বাংলাদেশী আমেরিকানদের জন্য প্রথম ও বিশ্বস্ত কেন্দ্রে পরিণত হওয়া, যা আমাদের স্থানীয় আশেপাশে ঐক্য, অ্যাডভোকেসি এবং অর্থনৈতিক ক্ষমতায়ন প্রচারের জন্য পরিচিত।' },
        'leadership_intro': { 'en': 'BAF-M is run by dedicated community leaders who volunteer their time and expertise. Transparency and accountability are our guiding principles. Learn more about the individuals steering our mission and join our growing team of dedicated volunteers.', 'bn': 'BAF-M পরিচালিত হয় নিবেদিতপ্রাণ কমিউনিটি নেতাদের দ্বারা, যারা তাদের সময় ও দক্ষতা স্বেচ্ছাসেবামূলকভাবে প্রদান করেন। স্বচ্ছতা ও জবাবদিহিতা আমাদের পথনির্দেশক নীতি। আমাদের মিশন পরিচালনাকারী ব্যক্তিরা সম্পর্কে জানুন এবং আমাদের নিবেদিত স্বেচ্ছাসেবকদের ক্রমবর্ধমান দলে যোগ দিন।' },
        'cta_view_events': { 'en': 'VIEW UPCOMING EVENTS', 'bn': 'আসন্ন অনুষ্ঠান দেখুন' },
        'cta_meet_leaders': { 'en': 'MEET OUR LEADERS', 'bn': 'আমাদের নেতাদের সাথে পরিচিত হন' },
        'cta_submit_need': { 'en': 'SUBMIT CONTENT/NEED', 'bn': 'কন্টেন্ট/প্রয়োজন জমা দিন' },
        'cta_find_resources': { 'en': 'FIND LOCAL RESOURCES (Directory)', 'bn': 'স্থানীয় রিসোর্স খুঁজুন (ডিরেক্টরি)' },
        'cta_emergency_contacts': { 'en': 'VIEW EMERGENCY CONTACTS', 'bn': 'জরুরী যোগাযোগ নম্বর দেখুন' },
        'featured_events_title': { 'en': 'Featured Upcoming Events', 'bn': 'ফিচারড আসন্ন অনুষ্ঠান' },
        'quick_access_title': { 'en': 'Quick Access', 'bn': 'তাৎক্ষণিক প্রবেশাধিকার' },
        // Home Page Core Programs (Part IV.F)
        'program_1': { 'en': 'To unify the Bangladeshi American Muslim population.', 'bn': 'বাংলাদেশী আমেরিকান মুসলিম জনগোষ্ঠীকে ঐক্যবদ্ধ করা।' },
        'program_2': { 'en': 'To try to provide overall cooperation in solving various social problems of the community.', 'bn': 'কমিউনিটির বিভিন্ন সামাজিক সমস্যা সমাধানে সার্বিক সহযোগিতা করার চেষ্টা করা।' },
        'program_3': { 'en': 'To collaborate with the entire community in national and local elections to support qualified candidates.', 'bn': 'জাতীয় এবং লোকাল নির্বাচনে কমিউনিটির সবাইকে নিয়ে যোগ্য প্রার্থীকে সহযোগিতা করা।' },
        'program_4': { 'en': 'To adopt various programs aimed at developing our next generation into ideal citizens based on correct values.', 'bn': 'আমাদের নেক্সট জেনারেশনকে সঠিক মূল্যবোধের ভিত্তিতে আদর্শ নাগরিক হিসেবে গড়ে তোলার লক্ষ্যে বিভিন্ন কর্মসূচি গ্রহণ করা।' },
        'program_5': { 'en': 'To conduct necessary demonstrations to protect our beloved motherland Bangladesh from foreign aggression.', 'bn': 'প্রিয় মাতৃভূমি বাংলাদেশকে বৈদেশিক আগ্রাসনের হাত থেকে রক্ষা কল্পে প্রয়োজনীয় ডেমোস্ট্রেশন করা।' },
        'program_6': { 'en': 'To cooperate in forming a patriotic government in the light of the majority Muslim consciousness.', 'bn': 'সংখ্যাগরিষ্ঠ মুসলমানদের চেতনার আলোকে দেশপ্রেমিক সরকার গঠনে সহযোগিতা করা।' },
        'program_7': { 'en': 'To endeavor to build public opinion against crimes against humanity.', 'bn': 'মানবতাবিরোধী অপরাধের বিরুদ্ধে জনমত গড়ে তোলার প্রচেষ্টা চালানো।' },

        // Spotlight Page (Part IV.B & C)
        'spotlight_headline': { 'en': 'Community Spotlight, Leadership & Partners', 'bn': 'কমিউনিটি স্পটলাইট, নেতৃত্ব এবং অংশীদার' },
        'spotlight_body': { 'en': 'This hub recognizes the individuals, leaders, and partners who make the BAF-M community strong. From our monthly volunteer recognition to our generous sponsors, this is where we celebrate success and foster collaboration.', 'bn': 'এই কেন্দ্রটি সেই ব্যক্তি, নেতা এবং অংশীদারদের সম্মান জানায় যারা BAF-M সম্প্রদায়কে শক্তিশালী করে তোলে। আমাদের মাসিক স্বেচ্ছাসেবক স্বীকৃতি থেকে শুরু করে আমাদের উদার স্পন্সর পর্যন্ত, এখানেই আমরা সাফল্য উদযাপন করি এবং সহযোগিতা বাড়াই।' },
        'spotlight_cta_nominate': { 'en': 'NOMINATE A SPOTLIGHT', 'bn': 'একটি স্পটলাইট নমিনেশন করুন' },
        'volunteer_otm_headline': { 'en': 'Volunteer of the Month', 'bn': 'এই মাসের স্বেচ্ছাসেবক' },
        'sponsor_dir_headline': { 'en': 'BAF-M Sponsor Directory (Our Partners)', 'bn': 'BAF-M স্পন্সর ডিরেক্টরি (আমাদের অংশীদারগণ)' },
        'sponsor_dir_body': { 'en': 'We are deeply grateful to the businesses and organizations whose financial support makes our community events and initiatives possible. All businesses listed here are BAF-M sponsors, ensuring they are dedicated partners to our mission. Click to view their websites and support those who support us!', 'bn': 'আমরা সেইসব ব্যবসা এবং সংস্থাগুলির কাছে গভীরভাবে কৃতজ্ঞ যাদের আর্থিক সহায়তা আমাদের কমিউনিটি ইভেন্ট এবং উদ্যোগগুলিকে সম্ভব করে তোলে। এখানে তালিকাভুক্ত সমস্ত ব্যবসা BAF-M এর স্পন্সর, যা নিশ্চিত করে যে তারা আমাদের মিশনের প্রতি নিবেদিত অংশীদার। তাদের ওয়েবসাইট দেখতে ক্লিক করুন এবং যারা আমাদের সমর্থন করে তাদের সমর্থন করুন!' },
        'business_dir_title': { 'en': 'Local Business Directory', 'bn': 'স্থানীয় ব্যবসার ডিরেক্টরি' },
        'biz_col_name': { 'en': 'Business Name / Organization', 'bn': 'ব্যবসা/সংস্থার নাম' },
        'biz_col_category': { 'en': 'Category / Service Type', 'bn': 'ক্যাটাগরি / সেবার ধরণ' },
        'biz_col_location': { 'en': 'Location / Address', 'bn': 'অবস্থান / ঠিকানা' },
        'biz_col_details': { 'en': 'Key Details / Notes', 'bn': 'মূল তথ্য / নোট' },

        // Events & Issues Page (Part IV.D)
        'events_issues_headline': { 'en': 'Upcoming Events & Local Civic Issues', 'bn': 'আসন্ন অনুষ্ঠান এবং স্থানীয় নাগরিক সমস্যা' },
        'events_issues_body': { 'en': 'Stay connected with BAF-M events, from cultural festivals to town halls, and track local policy decisions that impact your neighborhood. Use the Submissions tab to post an event or highlight a civic concern.', 'bn': 'সাংস্কৃতিক উৎসব থেকে শুরু করে টাউন হল পর্যন্ত BAF-M ইভেন্টগুলির সাথে সংযুক্ত থাকুন এবং আপনার আশেপাশের এলাকাকে প্রভাবিত করে এমন স্থানীয় নীতি সিদ্ধান্তগুলি ট্র্যাক করুন। একটি ইভেন্ট পোস্ট করতে বা নাগরিক উদ্বেগ তুলে ধরতে সাবমিশন ট্যাব ব্যবহার করুন।' },
        'upcoming_events_title': { 'en': 'Upcoming Events', 'bn': 'আসন্ন অনুষ্ঠান' },
        'past_events_title': { 'en': 'Past Events Gallery', 'bn': 'অতীত ইভেন্ট গ্যালারি' },
        'civic_summaries_title': { 'en': 'Local Civic Summaries', 'bn': 'স্থানীয় নাগরিক সারাংশ' },
        'event_location': { 'en': 'Location', 'bn': 'স্থান' },
        'event_datetime': { 'en': 'Date & Time', 'bn': 'তারিখ ও সময়' },
        'view_details': { 'en': 'বিস্তারিত দেখুন', 'bn': 'বিস্তারিত দেখুন' },

        // Volunteering Page (Part IV.E)
        'volunteer_headline': { 'en': 'Lend a Hand: Connect With Local Volunteer Opportunities', 'bn': 'হাত বাড়ান: স্থানীয় স্বেচ্ছাসেবার সুযোগগুলিতে যুক্ত হন' },
        'volunteer_body': { 'en': 'Whether you need a few hours of help with a community event, or you\'re looking to share your skills with a neighbor, BAF-M\'s Volunteer Hub connects willing hands with real local needs. This is where we build Michigan\'s Bangladeshi community together. All applications and postings are handled via the dedicated Submissions tab.', 'bn': 'কমিউনিটির কোনো ইভেন্টে আপনার কয়েক ঘণ্টার সাহায্য দরকার হোক বা আপনি কোনো প্রতিবেশীর সাথে আপনার দক্ষতা ভাগ করে নিতে চান, BAF-M এর স্বেচ্ছাসেবক হাব ইচ্ছুক হাতগুলিকে স্থানীয় প্রকৃত প্রয়োজনের সাথে যুক্ত করে। এভাবেই আমরা মিশিগানের বাংলাদেশী সম্প্রদায়কে একসাথে গড়ে তুলি। সমস্ত আবেদন এবং পোস্টিং ডেডিকেটেড সাবমিশন ট্যাবের মাধ্যমে পরিচালিত হয়।' },
        'needs_list_title': { 'en': 'Open Volunteer Needs', 'bn': 'খোলা স্বেচ্ছাসেবক প্রয়োজন' },
        'skills_req_label': { 'en': 'Skills Required', 'bn': 'প্রয়োজনীয় দক্ষতা' },
        'time_commitment': { 'en': 'Time Commitment', 'bn': 'সময় প্রতিশ্রুতি' },
        'cta_i_want_to_volunteer': { 'en': 'SUBMIT: I WANT TO VOLUNTEER/APPLY NOW', 'bn': 'জমা দিন: স্বেচ্ছাসেবক হতে চাই/এখনই আবেদন করুন' },
        'cta_post_a_need': { 'en': 'SUBMIT: POST A VOLUNTEER NEED', 'bn': 'জমা দিন: একটি স্বেচ্ছাসেবার প্রয়োজন পোস্ট করুন' },

        // Submission Hub (Part IV.F)
        'submit_hub_headline': { 'en': 'Community Content Submission Hub', 'bn': 'কমিউনিটি কন্টেন্ট জমা দেওয়ার কেন্দ্র' },
        'submit_hub_body': { 'en': 'This is the unified intake form for all content, participation, and ideas. Please select the appropriate submission type below (Event, Issue, Volunteer, Spotlight, etc.) to ensure your request is routed to the correct BAF-M team for review and publishing.', 'bn': 'এটি সমস্ত কন্টেন্ট, অংশগ্রহণ এবং ধারণার জন্য একটি সমন্বিত ইনটেক ফর্ম। আপনার অনুরোধটি সঠিক BAF-M টিমের কাছে পর্যালোচনা এবং প্রকাশের জন্য পাঠানো হয়েছে তা নিশ্চিত করতে অনুগ্রহ করে নিচে সঠিক জমা দেওয়ার ধরণটি (অনুষ্ঠান, সমস্যা, স্বেচ্ছাসেবক, স্পটলাইট ইত্যাদি) নির্বাচন করুন।' },
        'field_submission_type': { 'en': 'Submission Type', 'bn': 'জমা দেওয়ার ধরণ' },
        'field_contact_name': { 'en': 'Your Name', 'bn': 'আপনার নাম' },
        'field_contact_email': { 'en': 'Your Email', 'bn': 'আপনার ইমেল' },
        'field_content_title': { 'en': 'Content Title (EN/BN)', 'bn': 'কন্টেন্ট শিরোনাম (EN/BN)' },
        'field_content_body': { 'en': 'Content Body/Description (EN/BN)', 'bn': 'কন্টেন্ট বডি/বিবরণ (EN/BN)' },
        'field_date_time': { 'en': 'Date/Time (YYYY-MM-DD HH:MM)', 'bn': 'তারিখ/সময় (YYYY-MM-DD HH:MM)' },
        'field_location': { 'en': 'Location/Address', 'bn': 'অবস্থান/ঠিকানা' },
        'field_skills': { 'en': 'Skills/Expertise (Comma-separated)', 'bn': 'দক্ষতা/বিশেষজ্ঞতা (কমা দ্বারা বিভক্ত)' },
        'field_category': { 'en': 'Category/Service Type (e.g., Restaurant, Real Estate)', 'bn': 'ক্যাটাগরি/সেবার ধরণ (যেমন: রেস্তোরাঁ, রিয়েল এস্টেট)' },
        'field_image_upload': { 'en': 'Image Upload Link (Optional)', 'bn': 'ছবি আপলোড লিঙ্ক (ঐচ্ছিক)' },
        'field_image_upload': { 'en': 'Image Upload Link (Optional)', 'bn': 'ছবি আপলোড লিঙ্ক (ঐচ্ছিক)' },
        'field_why_help': { 'en': 'Why I want to help (Optional)', 'bn': 'আমি কেন সাহায্য করতে চাই (ঐচ্ছিক)' },
        'field_expertise_area': { 'en': 'Expertise Area (e.g., Finance, IT)', 'bn': 'বিশেষজ্ঞতার ক্ষেত্র (যেমন: অর্থ, আইটি)' },
        'field_goals_background': { 'en': 'Goals/Background (Required)', 'bn': 'লক্ষ্য/পটভূমি (আবশ্যক)' },
        'field_area_of_need': { 'en': 'Area of Need (e.g., Resume review, Coding)', 'bn': 'প্রয়োজনের ক্ষেত্র (যেমন: জীবনবৃত্তান্ত পর্যালোচনা, কোডিং)' },
        'field_general_inquiry': { 'en': 'General Inquiry/Idea', 'bn': 'সাধারণ জিজ্ঞাসা/ধারণা' },
        'field_min_150': { 'en': 'Minimum 150 words required for this field.', 'bn': 'এই ফিল্ডের জন্য ন্যূনতম ১৫০ শব্দ আবশ্যক।' },
        'submission_success': { 'en': 'Submission successful! A BAF-M team member will review your request shortly.', 'bn': 'জমা দেওয়া সফল হয়েছে! BAF-M টিমের একজন সদস্য শীঘ্রই আপনার অনুরোধটি পর্যালোচনা করবেন।' },
        'submission_error': { 'en': 'Submission failed. Please check the console for details.', 'bn': 'জমা দিতে ব্যর্থ। বিস্তারিত জানার জন্য কনসোল পরীক্ষা করুন।' },
        'submit_button': { 'en': 'Submit Request', 'bn': 'অনুরোধ জমা দিন' },
        'required_field_error': { 'en': 'Please fill out all required fields.', 'bn': 'অনুগ্রহ করে সমস্ত প্রয়োজনীয় ফিল্ড পূরণ করুন।' },

        // Submission Type Options
        'type_event': { 'en': '1. Event Submission', 'bn': '১. অনুষ্ঠান জমা' },
        'type_issue': { 'en': '2. Local Civic Issue', 'bn': '২. স্থানীয় নাগরিক সমস্যা' },
        'type_volunteer_post': { 'en': '3. Volunteer Need (Post)', 'bn': '৩. স্বেচ্ছাসেবক প্রয়োজন (পোস্ট)' },
        'type_volunteer_apply': { 'en': '4. I Want To Volunteer', 'bn': '৪. আমি স্বেচ্ছাসেবক হতে চাই' },
        'type_mentor_offer': { 'en': '5. Mentorship Offer', 'bn': '৫. মেন্টরশিপ অফার' },
        'type_mentor_request': { 'en': '6. Mentorship Request', 'bn': '৬. মেন্টরশিপের অনুরোধ' },
        'type_inquiry': { 'en': '7. General Inquiry', 'bn': '৭. সাধারণ জিজ্ঞাসা' },
        'type_spotlight': { 'en': '8. Local Spotlight Nomination', 'bn': '৮. স্থানীয় স্পটলাইট নমিনেশন' },
        'type_inquiry': { 'en': '7. General Inquiry', 'bn': '৭. সাধারণ জিজ্ঞাসা' },
        'type_spotlight': { 'en': '8. Local Spotlight Nomination', 'bn': '৮. স্থানীয় স্পটলাইট নমিনেশন' },
        'type_business_listing': { 'en': '9. Business/Directory Listing', 'bn': '৯. ব্যবসা/ডিরেক্টরি তালিকা' },
        // NEW: Admin Portal Nav Link Text
        'nav_admin': { 'en': 'Admin Portal', 'bn': 'এডমিন পোর্টাল' },
    };

    const SUBMISSION_FIELDS = {
        '1. Event Submission': ['content_title', 'content_body', 'date_time', 'location', 'image_upload'],
        '2. Local Civic Issue': ['content_title', 'content_body', 'date_time', 'location', 'image_upload'],
        '3. Volunteer Need (Post)': ['content_title', 'content_body', 'date_time', 'location', 'skills'],
        '4. I Want To Volunteer': ['why_help', 'skills'],
        '5. Mentorship Offer': ['expertise_area', 'content_body', 'skills'],
        '6. Mentorship Request': ['area_of_need', 'goals_background', 'skills'],
        '7. General Inquiry': ['content_title', 'content_body'],
        '8. Local Spotlight Nomination': ['content_title', 'content_body', 'location', 'image_upload'],
        '9. Business/Directory Listing': ['content_title', 'content_body', 'location', 'category', 'image_upload'],
    };

    // --- FIREBASE INITIALIZATION & AUTHENTICATION ---
    const ADMIN_USER_ID = 'jqcqQkBCDURzaTi5giGltZeCq2n1';
    const initializeAppAndAuth = async () => {
        try {
            setLogLevel('debug'); // Enable Firestore logging
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }

            onAuthStateChanged(auth, (user) => {
                userId = user ? user.uid : 'anonymous-' + crypto.randomUUID();
                isAuthReady = true;
                document.getElementById('footer-user-id').textContent = userId;
                setupFirestoreListeners();
                renderApp();
            });
        } catch (error) {
            console.error("Firebase Initialization/Auth Error:", error);
            document.getElementById('loading-message').textContent = `Initialization Error: ${error.message}. Check console.`;
        }
    };

    // --- FIREBASE DATA LISTENERS (onSnapshot) ---
    const getPublicCollectionPath = (collectionName) => `/artifacts/${appId}/public/data/${collectionName}`;
    const getUserCollectionPath = () => `/artifacts/${appId}/users/${userId}/raw_submissions`;

    const setupFirestoreListeners = () => {
        if (!isAuthReady) return;

        // New: Admin listener for all submissions (only fetched for admin user later)
        if (userId === ADMIN_USER_ID) {
            onSnapshot(collection(db, getUserCollectionPath()), (snapshot) => {
                window.adminSubmissions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                window.adminSubmissions.sort((a, b) => b.submitted_at.toMillis() - a.submitted_at.toMillis());
                renderApp();
            }, (error) => console.error("Error fetching admin submissions:", error));
        }

        // 1. Events & Calendar (Public)

        // 1. Events & Calendar (Public)
        onSnapshot(collection(db, getPublicCollectionPath('events')), (snapshot) => {
            events = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            events.sort((a, b) => (a.event_datetime.toMillis() - b.event_datetime.toMillis()));
            renderApp();
        }, (error) => console.error("Error fetching events:", error));

        // 2. Spotlight Features (Public)
        onSnapshot(collection(db, getPublicCollectionPath('spotlights')), (snapshot) => {
            spotlights = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderApp();
        }, (error) => console.error("Error fetching spotlights:", error));

        // 3. Volunteer Needs (Public)
        onSnapshot(query(collection(db, getPublicCollectionPath('volunteer_needs')), where('is_active', '==', true)), (snapshot) => {
            volunteerNeeds = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderApp();
        }, (error) => console.error("Error fetching volunteer needs:", error));

        // 4. Local Business Directory (Public)
        onSnapshot(collection(db, getPublicCollectionPath('local_businesses')), (snapshot) => {
            localBusinesses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderApp();
        }, (error) => console.error("Error fetching local businesses:", error));

        // 5. Civic Issues (Public) - NEW
        onSnapshot(collection(db, getPublicCollectionPath('civic_issues')), (snapshot) => {
            civicIssues = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderApp();
        }, (error) => console.error("Error fetching civic issues:", error));

        // Note: Leadership (leadership) could be added here similarly.
    };

    // --- LANGUAGE SWITCHING (attached to window) ---
    window.setLanguage = (lang) => {
        currentLang = lang;
        window.currentLang = lang; // Keep window.currentLang updated
        localStorage.setItem('bafm_lang', lang);
        renderApp();
        renderHeader(); // Ensure the toggle button text updates immediately
    };

    // --- ROUTING & PAGE RENDERING (Using Hash-based routing to avoid SecurityError) ---
    // The ADMIN_USER_ID is defined above near Firebase config for easy modification.

    const routeMap = {
        '/': 'home',
        '/spotlight': 'spotlight',
        '/events-and-issues': 'events',
        '/volunteer': 'volunteer',
        '/submit-content': 'submit',
        '/admin-portal': 'admin', // NEW: Admin Route
    };

    const getPageFromPath = (path) => {
        // Path starts with / and is defined in routeMap (e.g., '/spotlight')
        return routeMap[path] || 'home';
    };

    // Function to handle route change based on a path (e.g., '/')
    // Attached to window for inline HTML access
    window.navigateTo = (path) => {
        currentPage = getPageFromPath(path);
        // Safely update the URL hash
        window.location.hash = path;
        // Close the mobile menu after navigation
        isMobileMenuOpen = false; 
        renderApp();
    };

    // NEW: Function to toggle the mobile menu state
    window.toggleMobileMenu = () => {
        isMobileMenuOpen = !isMobileMenuOpen;
        renderApp();
    };

    // Determine initial page state from the hash
    const initialHash = window.location.hash.substring(1) || '/';
    let currentPage = getPageFromPath(initialHash);

    // Set up hash change listener (replaces onpopstate)
    window.onhashchange = () => {
        const newHash = window.location.hash.substring(1) || '/';
        currentPage = getPageFromPath(newHash);
        renderApp();
    };

    const renderHeader = () => {
        const navItems = [
            { path: '/', key: 'nav_home' },
            { path: '/spotlight', key: 'nav_spotlight' },
            { path: '/events-and-issues', key: 'nav_events' },
            { path: '/volunteer', key: 'nav_volunteer' },
            { path: '/submit-content', key: 'nav_submit' },
        ];
        
        // Add Admin Portal link if the current user is the admin
        if (userId === ADMIN_USER_ID) {
             navItems.push({ path: '/admin-portal', key: 'nav_admin' });
        }


        // Determine the target language for the toggle button
        const targetLang = currentLang === 'en' ? 'bn' : 'en';

        const headerHtml = `
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-20">
                    <a href="#/" onclick="event.preventDefault(); navigateTo('/')" class="text-2xl font-bold text-green-700 hover:text-green-900 transition-colors rounded-lg p-2">BAF-M</a>

                    <nav class="hidden md:flex space-x-2">
                        ${navItems.map(item => `
                            <a href="#${item.path}"
                                onclick="event.preventDefault(); navigateTo('${item.path}')"
                                class="text-gray-600 hover:text-gray-900 px-3 py-2 text-sm font-medium transition-colors
                                ${currentPage === (item.key === 'nav_admin' ? 'admin' : item.key.replace('nav_', '').split('-')[0]) ? 'nav-active' : 'hover:bg-gray-100 rounded-full'}"
                            >
                                ${t(item.key)}
                            </a>
                        `).join('')}
                    </nav>

                    <div class="flex items-center space-x-4">
                        <button onclick="setLanguage('${targetLang}')"
                            class="text-sm font-bold w-12 h-8 rounded-full transition-colors ${currentLang === 'bn' ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-800'} shadow-md">
                            ${t('language_toggle')}
                        </button>

                        <button type="button" onclick="toggleMobileMenu()" 
                            class="md:hidden inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500" 
                            aria-expanded="${isMobileMenuOpen}">
                            <svg class="${isMobileMenuOpen ? 'hidden' : 'block'} h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                            </svg>
                            <svg class="${isMobileMenuOpen ? 'block' : 'hidden'} h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <div class="${isMobileMenuOpen ? 'block' : 'hidden'} md:hidden border-t border-gray-100 pb-2">
                <div class="pt-2 pb-3 space-y-1 px-2">
                    ${navItems.map(item => `
                        <a href="#${item.path}" 
                            onclick="event.preventDefault(); navigateTo('${item.path}')"
                            class="block px-3 py-2 rounded-md text-base font-medium transition-colors
                            ${currentPage === (item.key === 'nav_admin' ? 'admin' : item.key.replace('nav_', '').split('-')[0]) ? 'nav-active' : 'text-gray-700 hover:bg-gray-100 hover:text-gray-900'}"
                        >
                            ${t(item.key)}
                        </a>
                    `).join('')}
                </div>
            </div>
        `;
        document.getElementById('header').innerHTML = headerHtml;
    };

    const renderHome = () => {
        const featuredEvents = events.filter(e => e.event_datetime.toMillis() > Date.now()).slice(0, 3);
        const eventCards = featuredEvents.length > 0 ? featuredEvents.map(event => `
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                <h3 class="text-xl font-semibold mb-2 text-green-700">${t_data(event, 'title')}</h3>
                <p class="text-sm text-gray-500 mb-3"><strong class="font-medium">${t('event_datetime')}:</strong> ${new Date(event.event_datetime.toMillis()).toLocaleString(currentLang === 'bn' ? 'bn-BD' : 'en-US', { dateStyle: 'medium', timeStyle: 'short' })}</p>
                <p class="text-gray-700 mb-4 line-clamp-3">${t_data(event, 'desc')}</p>
                <a href="#/events-and-issues" onclick="event.preventDefault(); navigateTo('/events-and-issues')" class="text-sm font-medium text-indigo-600 hover:text-indigo-800">${t('view_details')} &rarr;</a>
            </div>
        `).join('') : `<p class="col-span-3 text-center text-gray-500">${t('no_content_available')}</p>`;

        const programs = [
            'program_1', 'program_2', 'program_3', 'program_4',
            'program_5', 'program_6', 'program_7'
        ];

        return `
            <!-- Hero Section -->
            <div class="text-center py-12 md:py-20 bg-green-50 rounded-2xl shadow-inner mb-12">
                <h1 class="text-4xl md:text-5xl font-extrabold text-gray-800 mb-4 max-w-4xl mx-auto leading-tight">${t('hero_headline')}</h1>
                <p class="text-lg text-gray-600 mb-8 max-w-3xl mx-auto">${t('hero_body')}</p>
                <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4">
                    <button onclick="navigateTo('/events-and-issues')" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-full transition-colors shadow-lg">${t('cta_view_events')}</button>
                    <button onclick="navigateTo('/submit-content')" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-full transition-colors shadow-lg">${t('cta_submit_need')}</button>
                </div>
            </div>

            <!-- Mission, Vision & Leadership -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-12">
                <div class="bg-white p-8 rounded-xl shadow-lg border-t-4 border-green-500">
                    <h2 class="text-2xl font-bold mb-3 text-gray-800">${t('mission_title')}</h2>
                    <p class="text-gray-600">${t('mission_body')}</p>
                </div>
                <div class="bg-white p-8 rounded-xl shadow-lg border-t-4 border-indigo-500">
                    <h2 class="text-2xl font-bold mb-3 text-gray-800">${t('vision_title')}</h2>
                    <p class="text-gray-600">${t('vision_body')}</p>
                </div>
                <div class="bg-white p-8 rounded-xl shadow-lg border-t-4 border-yellow-500">
                    <h2 class="text-2xl font-bold mb-3 text-gray-800">Leadership</h2>
                    <p class="text-gray-600 mb-4">${t('leadership_intro')}</p>
                    <button onclick="navigateTo('/spotlight')" class="text-sm font-semibold text-indigo-600 hover:text-indigo-800">${t('cta_meet_leaders')} &rarr;</button>
                </div>
            </div>

            <!-- Core Programs (Mandatory List) -->
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Agenda</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-12">
                ${programs.map(key => `
                    <div class="bg-white p-5 rounded-lg shadow-md border border-gray-200 flex items-start space-x-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-500 flex-shrink-0 mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p class="text-gray-700 text-sm">${t(key)}</p>
                    </div>
                `).join('')}
            </div>


            <!-- Featured Events & Quick Access -->
            <h2 class="text-3xl font-bold text-gray-800 mb-6">${t('featured_events_title')}</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
                ${eventCards}
            </div>

            <h2 class="text-3xl font-bold text-gray-800 mb-6">${t('quick_access_title')}</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <button onclick="navigateTo('/spotlight')" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-4 px-6 rounded-xl transition-colors shadow-md text-lg">${t('cta_find_resources')}</button>
                <a href="tel:911" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-6 rounded-xl transition-colors shadow-md text-lg text-center">${t('cta_emergency_contacts')} (911)</a>
                <button onclick="navigateTo('/submit-content')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-xl transition-colors shadow-md text-lg">${t('cta_submit_need')}</button>
            </div>
        `;
    };

    const renderSpotlight = () => {
        // Mock data/logic for dynamic sections until proper collections are fetched/populated
        const businessDirectory = renderBusinessDirectory();

        // Use the first item from spotlights collection as the feature, filter by type if needed
        const featuredSpotlight = spotlights.find(s => s.type === 'Business' || s.type === 'Story');

        const volunteerOfTheMonth = spotlights.find(s => s.type === 'VolunteerOTM');

        return `
            <h1 class="text-4xl font-extrabold text-gray-800 mb-4">${t('spotlight_headline')}</h1>
            <p class="text-lg text-gray-600 mb-8 max-w-4xl">${t('spotlight_body')}</p>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-12">
                <!-- Main Spotlight Feature -->
                <div class="lg:col-span-2 bg-white p-8 rounded-xl shadow-xl border-l-4 border-green-500">
                    ${featuredSpotlight ? `
                        <h2 class="text-3xl font-bold text-green-700 mb-3">${t_data(featuredSpotlight, 'title')}</h2>
                        <p class="text-sm text-gray-500 mb-4">Posted: ${new Date(featuredSpotlight.posted_date.toMillis()).toLocaleDateString()}</p>
                        <p class="text-gray-700 mb-6">${t_data(featuredSpotlight, 'story')}</p>
                        <button onclick="navigateTo('/submit-content')" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-full transition-colors shadow-md text-sm">${t('spotlight_cta_nominate')}</button>
                    ` : `<p class="text-center text-gray-500">${t('no_content_available')}</p>`}
                </div>

                <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-indigo-500 flex flex-col justify-between">
                    <div>
                        <h2 class="text-2xl font-bold text-indigo-700 mb-2">${t('volunteer_otm_headline')}</h2>
                        ${volunteerOfTheMonth ? `
                            <h3 class="text-xl font-semibold mb-3">${t_data(volunteerOfTheMonth, 'title')}</h3>
                            <p class="text-gray-700">${t_data(volunteerOfTheMonth, 'story')}</p>
                        ` : `<p class="text-gray-500 italic">${t('no_content_available')}</p>`}
                    </div>
                    <button onclick="navigateTo('/volunteer')" class="mt-4 w-full bg-gray-100 hover:bg-gray-200 text-indigo-600 font-semibold py-2 rounded-full transition-colors">View All Volunteer Needs</button>
                </div>
            </div>

            <!-- Sponsor Directory -->
            <div class="mb-12">
                <h2 class="text-3xl font-bold text-gray-800 mb-4">${t('sponsor_dir_headline')}</h2>
                <p class="text-gray-600 mb-6 max-w-4xl">${t('sponsor_dir_body')}</p>
                <!-- NOTE: Sponsor data (collection: sponsors) is not actively fetched here but the section is created -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <p class="text-center text-gray-500 italic">Sponsor logos/names would display here from the Firestore 'sponsors' collection.</p>
                </div>
            </div>

            <!-- Local Business Directory -->
            ${renderBusinessDirectory()}

            <!-- Leadership Bio Section (Placeholder) -->
            <div class="mt-12">
                <h2 class="text-3xl font-bold text-gray-800 mb-4">BAF-M Leadership</h2>
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <p class="text-gray-700">Leadership bios will be displayed here, fetched from the Firestore 'leadership' collection.</p>
                </div>
            </div>
        `;
    };

    const renderBusinessDirectory = () => {
        const directoryData = localBusinesses; // Data must come from Firestore only now

        return `
            <h2 class="text-3xl font-bold text-gray-800 mb-4">${t('business_dir_title')}</h2>
            ${directoryData.length === 0 ? `<p class="text-center text-gray-500 py-4 italic">${t('no_content_available')}</p>` : ''}
            <div class="bg-white p-4 md:p-6 rounded-xl shadow-lg overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">${t('biz_col_name')}</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">${t('biz_col_category')}</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">${t('biz_col_location')}</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">${t('biz_col_details')}</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${directoryData.map(biz => `
                            <tr>
                                <td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${biz.name || biz.title_en}</td>
                                <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${biz.category || biz.category_en}</td>
                                <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${biz.address || biz.location}</td>
                                <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${biz.details || biz.website || 'N/A'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    };

    const renderEvents = () => {
// ...
        const upcoming = events.filter(e => e.event_datetime.toMillis() > Date.now());
        const past = events.filter(e => e.event_datetime.toMillis() <= Date.now());
        const issues = civicIssues; // Use the new civicIssues array

        const eventToHtml = (event, isPast) => {
            const date = new Date(event.event_datetime.toMillis()).toLocaleString(currentLang === 'bn' ? 'bn-BD' : 'en-US', { dateStyle: 'full', timeStyle: 'short' });
            return `
                <div class="bg-white p-6 rounded-xl shadow-lg ${isPast ? 'opacity-70' : 'border-t-4 border-green-500'}">
                    <h3 class="text-xl font-semibold mb-2 ${isPast ? 'text-gray-600' : 'text-green-700'}">${t_data(event, 'title')}</h3>
                    <p class="text-sm text-gray-500 mb-1"><strong class="font-medium">${t('event_datetime')}:</strong> ${date}</p>
                    <p class="text-sm text-gray-500 mb-3"><strong class="font-medium">${t('event_location')}:</strong> ${event.location || 'Online'}</p>
                    <div class="text-gray-700 mt-2">${t_data(event, 'desc')}</div>
                </div>
            `;
        };

        const issueToHtml = (issue) => {
            const date = new Date(issue.posted_date.toMillis()).toLocaleDateString(currentLang === 'bn' ? 'bn-BD' : 'en-US', { dateStyle: 'medium' });
            return `
                <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-blue-500">
                    <h3 class="text-xl font-semibold mb-2 text-blue-700">${t_data(issue, 'title')}</h3>
                    <p class="text-sm text-gray-500 mb-3">Posted: ${date} / Location: ${issue.location || 'Metro Detroit'}</p>
                    <div class="text-gray-700 mt-2">${t_data(issue, 'body')}</div>
                </div>
            `;
        };

        return `
            <h1 class="text-4xl font-extrabold text-gray-800 mb-4">${t('events_issues_headline')}</h1>
            <p class="text-lg text-gray-600 mb-8 max-w-4xl">${t('events_issues_body')}</p>

            <h2 class="text-3xl font-bold text-gray-800 mb-6">${t('upcoming_events_title')}</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-12">
                ${upcoming.length > 0 ? upcoming.map(e => eventToHtml(e, false)).join('') : `<p class="col-span-2 text-gray-500">${t('no_content_available')}</p>`}
            </div>

            <h2 class="text-3xl font-bold text-gray-800 mb-6">${t('civic_summaries_title')}</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-12">
                ${issues.length > 0 ? issues.map(issueToHtml).join('') : `
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-blue-500 md:col-span-2">
                        <p class="text-gray-700 font-medium">No active civic issues or local policy summaries available right now.</p>
                        <p class="text-sm text-gray-500 mt-2">Use the <a href="#/submit-content" onclick="navigateTo('/submit-content')" class="text-indigo-600 hover:text-indigo-800 font-semibold">Submissions Hub</a> to report a local civic concern.</p>
                    </div>
                `}
            </div>

            <h2 class="text-3xl font-bold text-gray-800 mb-6">${t('past_events_title')} (${past.length})</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                ${past.length > 0 ? past.map(e => eventToHtml(e, true)).join('') : `<p class="col-span-2 text-gray-500">${t('no_content_available')}</p>`}
            </div>
        `;
    };

    const renderVolunteer = () => {
        const needsCards = volunteerNeeds.length > 0 ? volunteerNeeds.map(need => `
            <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-yellow-500">
                <h3 class="text-xl font-semibold mb-2 text-yellow-700">${t_data(need, 'title')}</h3>
                <p class="text-gray-700 mb-4">${t_data(need, 'details')}</p>
                <p class="text-sm text-gray-500 mb-2"><strong class="font-medium">${t('skills_req_label')}:</strong> ${need.skills_req || 'Any helpful skill'}</p>
                <p class="text-sm text-gray-500 mb-4"><strong class="font-medium">${t('time_commitment')}:</strong> ${new Date(need.event_datetime.toMillis()).toLocaleDateString()} to ${new Date(need.end_datetime?.toMillis() || need.event_datetime.toMillis()).toLocaleDateString()}</p>
                <button onclick="navigateTo('/submit-content'); setTimeout(() => document.getElementById('submission_type').value = '4. I Want To Volunteer', 100);"
                    class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-full transition-colors text-sm">
                    ${t('cta_i_want_to_volunteer')}
                </button>
            </div>
        `).join('') : `<p class="col-span-3 text-center text-gray-500">${t('no_content_available')}</p>`;

        return `
            <h1 class="text-4xl font-extrabold text-gray-800 mb-4">${t('volunteer_headline')}</h1>
            <p class="text-lg text-gray-600 mb-8 max-w-4xl">${t('volunteer_body')}</p>

            <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mb-12">
                <button onclick="navigateTo('/submit-content'); setTimeout(() => document.getElementById('submission_type').value = '4. I Want To Volunteer', 100);"
                    class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-xl transition-colors shadow-lg flex-1">
                    ${t('cta_i_want_to_volunteer')}
                </button>
                <button onclick="navigateTo('/submit-content'); setTimeout(() => document.getElementById('submission_type').value = '3. Volunteer Need (Post)', 100);"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl transition-colors shadow-lg flex-1">
                    ${t('cta_post_a_need')}
                </button>
            </div>

            <!-- Open Volunteer Needs List -->
            <h2 class="text-3xl font-bold text-gray-800 mb-6">${t('needs_list_title')}</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                ${needsCards}
            </div>

            <!-- Skills Exchange/Mentorship Placeholder -->
            <div class="mt-12">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Skills Exchange & Mentorship</h2>
                <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-indigo-500">
                    <p class="text-gray-700">Matching forms and lists for mentorship offers (Type 5) and requests (Type 6) are processed through the Submissions Hub.</p>
                </div>
            </div>
        `;
    };

    const renderSubmissionHub = () => {
        const submissionTypes = [
            'type_event', 'type_issue', 'type_volunteer_post', 'type_volunteer_apply',
            'type_mentor_offer', 'type_mentor_request', 'type_inquiry', 'type_spotlight', 'type_business_listing'
        ].map(key => ({
            value: key.split('_').pop() === 'event' ? '1. Event Submission' : t(key),
            label: t(key)
        }));

        const renderConditionalFields = () => {
            const selectedType = document.getElementById('submission_type')?.value;
            const fieldKeys = SUBMISSION_FIELDS[selectedType] || [];

            // Determine if the current submission type is 'Event Submission'
            const isEventSubmission = selectedType === '1. Event Submission';

            const fieldMap = {
                'content_title': { label: t('field_content_title'), type: 'text', required: true, note: 'Bilingual translation encouraged.' },
                'content_body': { label: t('field_content_body'), type: 'textarea', required: true, minWords: 150, note: t('field_min_150') },
                'date_time': { label: t('field_date_time'), type: 'text', required: true, placeholder: '2025-12-31 18:00' },
                'location': { label: t('field_location'), type: 'text', required: true, placeholder: '123 Main St, Warren MI' },
                'skills': { label: t('field_skills'), type: 'text', required: true, placeholder: 'e.g., event setup, finance, graphic design' },
                'category': { label: t('field_category'), type: 'text', required: true, placeholder: 'e.g., Restaurant, Real Estate' }, // NEW FIELD
                'image_upload': { 
                    label: t('field_image_upload'), 
                    type: 'text', 
                    required: isEventSubmission, 
                    placeholder: 'Paste image or logo URL here' 
                },
                'why_help': { label: t('field_why_help'), type: 'textarea', required: false },
                'expertise_area': { label: t('field_expertise_area'), type: 'text', required: true },
                'goals_background': { label: t('field_goals_background'), type: 'textarea', required: true },
                'area_of_need': { label: t('field_area_of_need'), type: 'text', required: true },
            };

            return fieldKeys.map(key => {
// ... (rest of the renderConditionalFields function)
                const field = fieldMap[key];
                if (!field) return '';
                const id = `field_${key}`;
                const required = field.required ? 'required' : '';
                const requiredStar = field.required ? '<span class="text-red-500">*</span>' : '';

                if (field.type === 'textarea') {
                    return `
                        <div class="mb-4">
                            <label for="${id}" class="block text-sm font-medium text-gray-700">${field.label} ${requiredStar}</label>
                            <textarea id="${id}" name="${id}" rows="4" ${required} class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3">${field.note || ''}</textarea>
                        </div>
                    `;
                } else {
                    return `
                        <div class="mb-4">
                            <label for="${id}" class="block text-sm font-medium text-gray-700">${field.label} ${requiredStar}</label>
                            <input type="${field.type}" id="${id}" name="${id}" ${required} placeholder="${field.placeholder || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3">
                            ${field.note ? `<p class="mt-1 text-xs text-gray-500">${field.note}</p>` : ''}
                        </div>
                    `;
                }
            }).join('');
        };

        // Central Submission Handler
        const handleSubmit = async (event) => {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const submissionType = formData.get('submission_type');
            const contactName = formData.get('field_contact_name');
            const contactEmail = formData.get('field_contact_email');

            // Simple required field check (does not validate conditional fields perfectly, but catches universals)
            if (!submissionType || !contactName || !contactEmail) {
                // IMPORTANT: Replaced alert() with console error and visual cue
                console.error(t('required_field_error'));
                document.getElementById('submission-error-message').textContent = t('required_field_error');
                document.getElementById('submission-error-message').classList.remove('hidden');
                document.getElementById('submission-error-message').classList.remove('bg-green-100', 'text-green-700');
                document.getElementById('submission-error-message').classList.add('bg-red-100', 'text-red-700');
                setTimeout(() => document.getElementById('submission-error-message').classList.add('hidden'), 5000);
                return;
            }

            // IMPORTANT: Clear previous errors
            document.getElementById('submission-error-message').classList.add('hidden');
            document.getElementById('submission-error-message').textContent = '';


            const payload = {};
            // Gather all fields that exist in the form
            for (const [key, value] of formData.entries()) {
                payload[key] = value;
            }

            // Remove universal fields from payload
            delete payload.submission_type;
            delete payload.field_contact_name;
            delete payload.field_contact_email;

            document.getElementById('submit-button').disabled = true;
            document.getElementById('submit-button').textContent = 'Submitting...';

            try {
                // Save to the private raw_submissions collection
                await addDoc(collection(db, getUserCollectionPath()), {
                    submission_type: submissionType,
                    contact_name: contactName,
                    contact_email: contactEmail,
                    user_id: userId,
                    payload: JSON.stringify(payload), // Store dynamic data as JSON string
                    status: 'pending',
                    submitted_at: Timestamp.now(),
                });
                // IMPORTANT: Replaced alert() with console success and visual cue
                document.getElementById('submission-error-message').textContent = t('submission_success');
                document.getElementById('submission-error-message').classList.remove('hidden');
                document.getElementById('submission-error-message').classList.remove('bg-red-100', 'text-red-700');
                document.getElementById('submission-error-message').classList.add('bg-green-100', 'text-green-700');
                
                form.reset();
                document.getElementById('conditional-fields-container').innerHTML = ''; // Clear fields
            } catch (e) {
                console.error("Error adding document: ", e);
                // IMPORTANT: Replaced alert() with console error and visual cue
                document.getElementById('submission-error-message').textContent = t('submission_error');
                document.getElementById('submission-error-message').classList.remove('hidden');
                document.getElementById('submission-error-message').classList.remove('bg-green-100', 'text-green-700');
                document.getElementById('submission-error-message').classList.add('bg-red-100', 'text-red-700');
            } finally {
                document.getElementById('submit-button').disabled = false;
                document.getElementById('submit-button').textContent = t('submit_button');
            }
        };

        // Attach event listener for dynamic field rendering
        setTimeout(() => {
            const typeDropdown = document.getElementById('submission_type');
            const fieldsContainer = document.getElementById('conditional-fields-container');
            const formElement = document.getElementById('submission-form');

            if (typeDropdown && fieldsContainer) {
                const updateFields = () => {
                    fieldsContainer.innerHTML = renderConditionalFields();
                };
                typeDropdown.addEventListener('change', updateFields);
                updateFields(); // Initial call to render default state or pre-selected value
            }
            if (formElement) {
                formElement.onsubmit = handleSubmit;
            }
        }, 0); // Delay execution to ensure DOM is rendered

        return `
            <h1 class="text-4xl font-extrabold text-gray-800 mb-4">${t('submit_hub_headline')}</h1>
            <p class="text-lg text-gray-600 mb-8 max-w-4xl">${t('submit_hub_body')}</p>

            <div class="bg-white p-6 md:p-10 rounded-xl shadow-2xl border-t-4 border-indigo-600 max-w-3xl mx-auto">
                <div id="submission-error-message" class="hidden p-3 mb-4 rounded-lg font-medium text-center transition-all bg-red-100 text-red-700" role="alert"></div>

                <form id="submission-form">
                    <!-- Universal Fields -->
                    <div class="mb-6">
                        <label for="submission_type" class="block text-lg font-bold text-indigo-700 mb-2">${t('field_submission_type')}<span class="text-red-500">*</span></label>
                        <select id="submission_type" name="submission_type" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 bg-gray-50 text-base">
                            <option value="" disabled selected>--- Select Submission Type ---</option>
                            ${submissionTypes.map(type => `<option value="${type.value}">${type.label}</option>`).join('')}
                        </select>
                    </div>

                    <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">Contact Info</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="mb-4">
                            <label for="field_contact_name" class="block text-sm font-medium text-gray-700">${t('field_contact_name')}<span class="text-red-500">*</span></label>
                            <input type="text" id="field_contact_name" name="field_contact_name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3">
                        </div>
                        <div class="mb-4">
                            <label for="field_contact_email" class="block text-sm font-medium text-gray-700">${t('field_contact_email')}<span class="text-red-500">*</span></label>
                            <input type="email" id="field_contact_email" name="field_contact_email" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3">
                        </div>
                    </div>

                    <!-- Conditional Fields (Renders based on Submission Type selection) -->
                    <div id="conditional-fields-container" class="mt-8">
                        <p class="text-center text-gray-500 italic">Select a Submission Type above to reveal the necessary fields.</p>
                    </div>

                    <button type="submit" id="submit-button" class="mt-8 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl transition-colors shadow-lg text-lg">
                        ${t('submit_button')}
                    </button>
                </form>
            </div>
        `;
    };

    const renderAdminPortal = () => {
        if (userId !== ADMIN_USER_ID) {
            return `<div class="p-20 text-center text-red-500">Access Denied. Only the Admin can view this page.</div>`;
        }

        const submissions = window.adminSubmissions || [];

        

        const submissionHtml = submissions.map(sub => {
            const date = new Date(sub.submitted_at.toMillis()).toLocaleString();
            const payload = JSON.parse(sub.payload);
            const statusColor = sub.status === 'approved' ? 'bg-green-100 text-green-800' : 
                                sub.status === 'rejected' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800';

            // --- NEW: Dynamic Summary Content ---
            let summaryContent = '';
            switch(sub.submission_type) {
                case '4. I Want To Volunteer':
                    const skills = payload.field_skills || 'None listed';
                    const whyHelp = payload.field_why_help || 'No reason provided';
                    summaryContent = `
                        <p class="text-gray-700 mb-1"><strong>Skills Offered:</strong> ${skills}</p>
                        <p class="text-gray-700 mb-4"><strong>Why Help:</strong> ${whyHelp.substring(0, 100)}${whyHelp.length > 100 ? '...' : ''}</p>
                    `;
                    break;
                case '1. Event Submission':
                case '2. Local Civic Issue':
                case '3. Volunteer Need (Post)':
                case '8. Local Spotlight Nomination':
                    const title = payload.field_content_title || 'No Title Provided';
                    const body = payload.field_content_body || 'No description available';
                    summaryContent = `
                        <h4 class="text-lg font-semibold text-gray-800 mb-2">${title}</h4>
                        <p class="text-gray-700 mb-4 line-clamp-2">${body.substring(0, 150)}${body.length > 150 ? '...' : ''}</p>
                    `;
                    break;
                default:
                    // For other types like Mentorship/Inquiry, only show the raw payload below.
                    summaryContent = `<p class="text-gray-600 italic mb-4">No structured summary defined for this type.</p>`;
                    break;
            }
            // --- END NEW: Dynamic Summary Content ---

            return `
                <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-indigo-500 mb-4">
                    <div class="flex justify-between items-center mb-3 border-b pb-2">
                        <h3 class="text-xl font-bold text-gray-800">${sub.submission_type}</h3>
                        <span class="px-3 py-1 text-sm font-semibold rounded-full ${statusColor}">${sub.status}</span>
                    </div>
                    <p class="text-sm text-gray-700 mb-1"><strong>Submitted By:</strong> ${sub.contact_name} (${sub.contact_email})</p>
                    <p class="text-sm text-gray-500 mb-4"><strong>Date:</strong> ${date} | <strong>User ID:</strong> ${sub.user_id}</p>
                    
                    <div class="my-4 p-3 bg-gray-50 rounded-lg">
                        ${summaryContent}
                    </div>
                    
                    ${sub.status === 'pending' ? `
                        <div class="mt-4 flex space-x-3">
                            <button onclick="approveSubmission('${sub.id}', '${sub.submission_type}', '${sub.payload}')"
                                class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-full transition-colors text-sm">
                                Approve & Publish
                            </button>
                            <button onclick="rejectSubmission('${sub.id}')"
                                class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full transition-colors text-sm">
                                Reject
                            </button>
                        </div>
                    ` : `<p class="mt-4 text-sm text-gray-600 italic">Review complete on ${new Date(sub.review_date?.toMillis()).toLocaleString()}.</p>`}
                </div>
            `;
        }).join('');

        return `
            <h1 class="text-4xl font-extrabold text-indigo-800 mb-4">🔑 Admin Portal: Submissions Review</h1>
            <p class="text-lg text-gray-600 mb-8 max-w-4xl">Review and approve community content before it goes live on the public pages (Events, Spotlights, Volunteer Needs).</p>

            <h2 class="text-3xl font-bold text-gray-800 mb-6">Pending Submissions (${submissions.filter(s => s.status === 'pending').length} Pending)</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                ${submissions.length > 0 ? submissionHtml : '<p class="text-center text-gray-500 lg:col-span-2">No submissions to review.</p>'}
            </div>
        `;
    };

    const renderApp = () => {
        if (!isAuthReady) {
            document.getElementById('loading-message').textContent = t('loading_data');
            return;
        }

        renderHeader();
        const container = document.getElementById('content-container');
        let contentHtml = '';

        switch (currentPage) {
            case 'home':
                contentHtml = renderHome();
                break;
            case 'spotlight':
                contentHtml = renderSpotlight();
                break;
            case 'events':
                contentHtml = renderEvents();
                break;
            case 'volunteer':
                contentHtml = renderVolunteer();
                break;
            case 'submit':
                contentHtml = renderSubmissionHub();
                break;
            case 'admin': // NEW: Admin Case
                contentHtml = renderAdminPortal();
                break;
            default:
                currentPage = 'home';
                contentHtml = renderHome();
                break;
        }

        document.getElementById('content-container').innerHTML = `<div class="max-w-7xl mx-auto">${contentHtml}</div>`;
        document.getElementById('current-year').textContent = new Date().getFullYear();
    };

    // --- INITIAL DATA SEEDING (For Local Business Directory) ---
    // The data is now intended to be added only via the Submission Hub/Admin Portal.
    // The previous getInitialBusinessData function has been removed.
    const approveSubmission = async (id, type, payloadString) => {
// ...
        if (!confirm(`Are you sure you want to APPROVE this ${type} submission?`)) return;

        const submissionRef = doc(db, getUserCollectionPath(), id);
        const payload = JSON.parse(payloadString);
        const data = {};

        // Map fields from raw submission to public collection fields
        const mapField = (key) => payload[`field_${key}`];

        switch(type) {
            case '1. Event Submission':
                data.title_en = mapField('content_title');
                data.title_bn = mapField('content_title'); // Assuming bilingual title is same or needs admin edit
                data.desc_en = mapField('content_body');
                data.desc_bn = mapField('content_body');
                data.location = mapField('location');
                data.image_url = mapField('image_upload');
                data.event_datetime = Timestamp.fromDate(new Date(mapField('date_time')));
                data.posted_date = Timestamp.now();
                await setDoc(doc(db, getPublicCollectionPath('events'), id), data);
                break;
            case '2. Local Civic Issue':
                data.title_en = mapField('content_title');
                data.title_bn = mapField('content_title');
                data.body_en = mapField('content_body');
                data.body_bn = mapField('content_body');
                data.location = mapField('location');
                data.image_url = mapField('image_upload');
                data.posted_date = Timestamp.now();
                // Assumes a 'civic_issues' public collection
                await setDoc(doc(db, getPublicCollectionPath('civic_issues'), id), data);
                break;
            case '3. Volunteer Need (Post)':
                data.title_en = mapField('content_title');
                data.title_bn = mapField('content_title');
                data.details_en = mapField('content_body');
                data.details_bn = mapField('content_body');
                data.location = mapField('location');
                data.skills_req = mapField('skills');
                data.event_datetime = Timestamp.fromDate(new Date(mapField('date_time')));
                data.is_active = true;
                data.posted_date = Timestamp.now();
                // Assumes a 'volunteer_needs' public collection
                await setDoc(doc(db, getPublicCollectionPath('volunteer_needs'), id), data);
                break;
            case '4. I Want To Volunteer':
                // This type is a private application to volunteer, not public content.
                // Only log the approval and fall through to update the status in raw_submissions.
                console.log(`Volunteer Application ${id} approved. No public document created.`);
                break;
            case '9. Business/Directory Listing':
                data.title_en = mapField('content_title');
                data.title_bn = mapField('content_title'); 
                data.details_en = mapField('content_body');
                data.details_bn = mapField('content_body');
                data.category = mapField('category');
                data.location = mapField('location');
                data.image_url = mapField('image_upload');
                data.posted_date = Timestamp.now();
                // Assumes a 'local_businesses' public collection
                await setDoc(doc(db, getPublicCollectionPath('local_businesses'), id), data);
                break;
                // Other types (Spotlight, etc.) would be handled here similarly.
            default:
                alert(`Approval logic for type "${type}" is not implemented.`);
                return;
        }

        // Update status in the raw_submissions collection
        await updateDoc(submissionRef, { status: 'approved', review_date: Timestamp.now() });
        console.log(`Submission ${id} (${type}) approved and published.`);
    };

    const rejectSubmission = async (id) => {
        if (!confirm('Are you sure you want to REJECT this submission?')) return;
        const submissionRef = doc(db, getUserCollectionPath(), id);
        await updateDoc(submissionRef, { status: 'rejected', review_date: Timestamp.now() });
        console.log(`Submission ${id} rejected.`);
    };

    // Attach global functions for inline calls
    window.approveSubmission = approveSubmission;
    window.rejectSubmission = rejectSubmission;
    // --- START APPLICATION ---
    window.onload = initializeAppAndAuth;
</script>
</body>
</html>
